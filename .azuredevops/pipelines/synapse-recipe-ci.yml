# The following variables should be set in the pipeline:
# - synSqlAdminUsername
# - synSqlAdminPassword
# The following variables are picked from the variable file "variables/synapse-recipe-bicep.yml":
# - resourceGroupName
# - resourceBaseName
# - location
# - vnetAddressPrefix
# - privateEndpointSubnetAddressPrefix
# - bastionSubnetAddressPrefix
# - operationsSubscriptionId
# - operationsResourceGroupName
# - newOrExistingDnsZones
# The following variables are selected at runtime:
# - azureServiceConnection

name: 'Azure Synapse Recipe CI'

parameters: 
- name: azureServiceConnection
  displayName: Azure Service Connection
  type: string
  default: dtd-subscription

trigger:
  branches:
    include:
    - 'main' 
  paths:
    include: 
    - '/src/az-synapse/deploy/bicep' 

pool: 
  vmImage: 'ubuntu-latest'

variables:
  azureServiceConnection: ${{ parameters.azureServiceConnection }}

stages:
  - stage: Build
    displayName: Build

    jobs:
      - job: BuildBicep
        displayName: Validate Bicep Files
        variables:
        - template: variables/synapse-recipe-bicep.yml
        steps:
          - template: ./templates/bicep-build.yml
            parameters:
              bicepPath: ./src/az-synapse/deploy/bicep/main.bicep
              bicepParameters: 'location=$(location) resourceBaseName=$(resourceBaseName) synSqlAdminUsername=$(SYNSQLADMINUSERNAME) synSqlAdminPassword=$(SYNSQLADMINPASSWORD) vnetAddressPrefix=$(vnetAddressPrefix) privateEndpointSubnetAddressPrefix=$(privateEndpointSubnetAddressPrefix) bastionSubnetAddressPrefix=$(bastionSubnetAddressPrefix) dnsZoneResourceGroupName=$(operationsResourceGroupName) dnsZoneSubscriptionId=$(operationsSubscriptionId) newOrExistingDnsZones=$(newOrExistingDnsZones)'
              serviceConnection: $(azureServiceConnection)
